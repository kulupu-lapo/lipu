---
import BaseLayout from "@/layouts/BaseLayout.astro";
---

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script lang="javascript">
  const rerender = async () => {
    let render = document.getElementById("md-render");
    let input = document.getElementById("md-input");
    // console.log(input.value);
    render.innerHTML = marked.parse(input.value);
  };

  const updateFileName = () => {
    let title = document.getElementById("title");
    let filename = document.getElementById("filename");
    filename.value = title.value
      .toLowerCase()
      .replaceAll(/[ _]/g, "-")
      .replaceAll(/[^\w\s\-]/g, "");
  };
  // const toggleAdvanced = async () => {
  //   let value = document.getElementById("toggle-advanced").checked;
  //   // console.log(value);
  //   for (let element of document.getElementsByClassName("advanced")) {
  //     element.style = `display: ${value ? "initial" : "none"}`;
  //   }
  // };
</script>
<script lang="javascript">
  const submit = async () => {
    let form = document.getElementById("form");
    let data = {
      "submitted-by": document.getElementById("submitted-by").value,
      filename: document.getElementById("filename").value,
      title: document.getElementById("title").value,
      description: document.getElementById("description").value,
      authors: document.getElementById("authors").value,
      date: document.getElementById("date").value,
      "date-precision": document.getElementById("date-precision").value,
      tags: document.getElementById("tags").value,
      license: document.getElementById("license").value,
      sources: document.getElementById("sources").value,
      notes: document.getElementById("notes").value,
      text: document.getElementById("md-input").value,
    };
    console.log(data);

    let submitButton = document.getElementById("submit");
    submitButton.value = "Submitting, please wait...";
    submitButton.onclick = "";
    let response = await fetch("https://submit-4gx.pages.dev/api/submit", {
      method: "POST",
      body: JSON.stringify(data),
      headers: {
        "Content-type": "application/json; charset=UTF-8",
      },
    });
    let responseBody = await response.json();

    if (responseBody.success) {
      document.getElementById("response").innerHTML =
        `Your article has been <a href="${responseBody.data.html_url}">received</a> and will be reviewed by volunteers!<br />Please make sure not to submit the same thing several times, thanks in advance!`;
    } else {
      document.getElementById("response").innerHTML =
        `Failed to upload article. Error message:<br />${JSON.stringify(responseBody.error)}<br />Show this to kala Asi at ma pona!`;
    }
    submitButton.value = "Submit article";
    submitButton.onclick = "submit()";
  };

  // document.getElementById("form").addEventListener("submit", (e) => {
  //   e.preventDefault();

  //   console.log(e);

  // const formData = new FormData(e.target);
  // const data = Array.from(formData.entries()).reduce((memo, [key, value]) => ({
  //   ...memo,
  //   [key]: value,
  // }), {});
  // document.getElementById('output').innerHTML = JSON.stringify(data);
  // });
</script>

<BaseLayout title={"Add an article"}>
  <section>
    <h1>Add your article</h1>
    <form id="form">
      <div>
        <h3>Submitted by</h3>
        <input
          id="submitted-by"
          required
          placeholder="your Toki Pona name goes here!"
        />
      </div>
      <div>
        <h3>File name</h3>
        <input id="filename" required placeholder="carry-feat-jan-kekan-san" />
      </div>
      <div>
        <h3>Title</h3>
        <input
          id="title"
          required
          oninput="updateFileName()"
          placeholder="carry (feat.) jan kekan san"
        />
      </div>
      <div>
        <h3>Description</h3>
        <input id="description" placeholder="A punny parody of Wayward Son" />
      </div>
      <div>
        <h3>Authors</h3>
        <input id="authors" required placeholder="jan Usawi, jan Kekan San" />
      </div>
      <div>
        <h3>Date published</h3>
        <div style="display: flex;">
          <input id="date" type="date" required />
          <select id="date-precision">
            <option selected value="day">Precise to the day</option>
            <option value="month">Precise to the month</option>
            <option value="year">Precise to the year</option>
            <option value="none">Complete guess</option>
          </select>
        </div>
      </div>
      <div>
        <h3>Tags</h3>
        <input id="tags" placeholder="music, pop, parody" />
      </div>
      <div>
        <h3>License</h3>
        <input id="license" placeholder="CC BY-SA-NC 4.0" />
      </div>
      <div>
        <h3>Sources</h3>
        <input
          id="sources"
          placeholder="https://janusawi.bandcamp.com/album/toki-gaming"
        />
      </div>
      <div>
        <h3>Notes</h3>
        <input id="notes" />
      </div>
      <!-- <input id="toggle-advanced" type="checkbox" oninput="toggleAdvanced()" />
      <label for="toggle-advanced">Show advanced options</label>
      <div class="advanced">
        <h3>Proofreaders</h3>
        <input id="proofreaders" />
      </div>
      <div class="advanced">
        <h3>Archives</h3>
        <input id="archives" />
      </div>
      <div class="advanced">
        <h3>Preprocessing</h3>
        <input id="preprocessing" />
      </div>
      <div class="advanced">
        <h3>Accessibility notes</h3>
        <input id="accessibility-notes" />
      </div> -->
    </form>
    <div>
      <h3>Text</h3>
      <textarea
        id="md-input"
        placeholder="## o sitelen kepeken nasin *Markdown*!"
        oninput="rerender()"></textarea>
    </div>
    <div id="md-render"></div>
    <input
      type="submit"
      id="submit"
      value="Submit article"
      onclick="submit()"
    />
    <div id="response"></div>
  </section>
</BaseLayout>

<style>
  h3 {
    margin: 0;
  }
  div {
    display: block;
  }
  input,
  select {
    padding: 10px;
    font-size: inherit;
    font-family: inherit;
    color: inherit;
    display: block;
    background-color: var(--bg);
    border: 1px solid var(--grey);
  }
  input:hover,
  select:hover {
    background-color: var(--bg-1);
  }

  input:not([type="checkbox"]),
  select {
    box-sizing: border-box;
    width: 100%;
  }
  #date,
  #date-precision {
    width: 50%;
  }
  textarea {
    box-sizing: border-box;
    padding: 10px;
    width: 100%;
    height: 200px;
  }
  /* .advanced {
    display: none;
  } */
</style>
